---
import { z } from "astro:schema";
import { experimental_getWranglerCommands } from "wrangler";
import WranglerCommand from "./WranglerCommand.astro";

const props = z.object({
	namespace: z.string(),
	headingLevel: z.number().default(2),
});

const { namespace, headingLevel } = props.parse(Astro.props);

const { registry } = experimental_getWranglerCommands();

const node = registry.subtree.get(namespace);

if (!node || node.subtree.size === 0) {
	throw new Error(`[WranglerNamespace] Namespace "${namespace}" not found`);
}

const definitions: NonNullable<(typeof node)["definition"]>[] = [];

function flattenSubtree(node: (typeof registry)["subtree"]) {
	for (const value of node.values()) {
		// skip commands marked as hidden
		if (value.definition?.metadata?.hidden) {
			continue;
		}
		if (value.definition?.type === "command") {
			definitions.push(value.definition);
		} else {
			flattenSubtree(value.subtree);
		}
	}
}

flattenSubtree(node.subtree);
---

{
	definitions.map((definition) => {
		if (definition.type !== "command") {
			throw new Error(
				`[WranglerNamespace] Expected "command" but got "${definition.type}" for "${definition.command}"`
			);
		}
		return (
			<WranglerCommand
				command={definition.command.replace("wrangler ", "")}
				headingLevel={headingLevel}
			/>
		);
	})
}
