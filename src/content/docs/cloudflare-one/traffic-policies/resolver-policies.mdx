---
pcx_content_type: configuration
title: Resolver policies
sidebar:
  order: 6
  badge:
    text: Beta
head:
  - tag: title
    content: Resolver policies
---

import { Render, Badge, GlossaryTooltip } from "~/components";

:::note
Only available on Enterprise plans.
:::

By default, Gateway sends DNS requests to [1.1.1.1](/1.1.1.1/), Cloudflare's public DNS resolver, for resolution. Enterprise users can instead create Gateway policies to route DNS queries to custom resolvers.

```mermaid
flowchart TD
    %% Accessibility
    accTitle: How Gateway routes DNS queries
    accDescr: Flowchart describing the order Cloudflare Gateway routes a DNS query from an endpoint through DNS and resolver policies back to the user.

    %% Flowchart
    user(["User"])-->endpoint[/"Gateway DNS endpoint"/]

    endpoint-->query["DNS policy (query)"]

    query-->resolver["Resolver policy"]

    resolver--"Routes to </br>custom resolver"-->response["DNS policy (response)"]

    response--"Returns response"-->user
```

Gateway will route user traffic to your configured DNS resolver based on the matching policy, even if your resolvers' IP addresses overlap.

## Use cases

You may use resolver policies if you require access to non-publicly routed domains, such as private network services or internal resources. You may also use resolver policies if you need to access a protected DNS service or want to simplify DNS management for multiple locations.

### Internal DNS <Badge text="Beta" variant="caution" size="small" />

[Cloudflare Internal DNS](/dns/internal-dns/) allows you to manage DNS records for internal resources on a private network. DNS zones configured in Internal DNS can only be queried by the Gateway resolver. With resolver policies, you can determine how Gateway resolves your organization's DNS queries to resolve to internal resources based on the context of the query, such as known source IPs for a geographic location.

To get started with resolving internal DNS queries with resolver policies, refer to [Get started](/dns/internal-dns/get-started/).

### Local Domain Fallback

If your resolver is only reachable by a client device and not by Gateway via a Cloudflare tunnel, Magic WAN tunnel, or other public Internet connections, you should configure [Local Domain Fallback](/cloudflare-one/team-and-resources/devices/warp/configure-warp/route-traffic/local-domains/) for your device. If both Local Domain Fallback and resolver policies are configured for the same device, Cloudflare will apply your client-side Local Domain Fallback rules first. If you onboard DNS queries to Gateway with the WARP client and route them with resolver policies, the source IP of the queries will be the IP address assigned by the WARP client.

<Render file="warp/ldf-best-practice" product="cloudflare-one" />

## Resolver connections

Resolver policies support TCP and UDP connections. Custom resolvers can point to the Internet via IPv4 or IPv6, or to a private network service, such as a [Magic tunnel](/magic-transit/how-to/configure-tunnel-endpoints/). Policies default to port `53`. You can change which port your resolver uses by customizing it in your policy.

You can protect your authoritative nameservers from DDoS attacks by enabling [DNS Firewall](/dns/dns-firewall/).

### Cloudflare Tunnel

You can configure connections to a private resolver connected to Cloudflare with [Cloudflare Tunnel](/cloudflare-one/networks/connectors/cloudflare-tunnel/). To ensure `cloudflared` can route UDP traffic to your resolver, connect your tunnel via [QUIC](/cloudflare-one/networks/connectors/cloudflare-tunnel/configure-tunnels/cloudflared-parameters/run-parameters/#protocol).

For more information on connecting a private DNS resolver to Cloudflare with Cloudflare Tunnel, refer to [Private DNS](/cloudflare-one/networks/connectors/cloudflare-tunnel/private-net/cloudflared/private-dns/).

### Magic WAN

To enable connections to a private resolver connected to Cloudflare via [Magic WAN](/magic-wan/), contact your account team.

### Available DNS endpoints

Resolver policies can route queries for resolution from the following DNS endpoints:

- IPv4
- IPv6
- [DNS over HTTPS (DoH)](/cloudflare-one/team-and-resources/devices/agentless/dns/dns-over-https/)
- [DNS over TLS (DoT)](/cloudflare-one/team-and-resources/devices/agentless/dns/dns-over-tls/)
- DNS queries generated by Cloudflare [Browser Isolation](/cloudflare-one/remote-browser-isolation/) and [Clientless Web Isolation](/cloudflare-one/remote-browser-isolation/setup/clientless-browser-isolation/)
- DNS queries generated by [proxy endpoints](/cloudflare-one/team-and-resources/devices/agentless/pac-files/)

Gateway will filter, resolve, and log your queries regardless of endpoint.

## Create a resolver policy

<Render file="gateway/create-resolver-policy" product="cloudflare-one" />

For more information on creating a DNS policy, refer to [DNS policies](/cloudflare-one/traffic-policies/dns-policies/).

<Render file="gateway/terraform-precedence-warning" product="cloudflare-one" />

## Selectors

### Content Categories

<Render
	file="gateway/selectors/dns-content-categories"
	product="cloudflare-one"
/>

### DNS Resolver IP

<Render file="gateway/selectors/dns-resolver-ip" product="cloudflare-one" />

### DoH Subdomain

<Render file="gateway/selectors/doh-subdomain" product="cloudflare-one" />

### Domain

<Render
	file="gateway/selectors/domain-dns"
	product="cloudflare-one"
	params={{ APIendpoint: "dns.domains" }}
/>

### Host

<Render
	file="gateway/selectors/host-dns"
	product="cloudflare-one"
	params={{ APIendpoint: "dns.fqdn" }}
/>

### Location

<Render file="gateway/selectors/location" product="cloudflare-one" />

### Query Record Type

<Render file="gateway/selectors/query-record-type" product="cloudflare-one" />

### Security Categories

<Render file="gateway/selectors/security-categories" product="cloudflare-one" />

### Source Continent

Use this selector to filter based on the continent where the query arrived to Gateway from. <Render product="cloudflare-one" file="gateway/selectors/source-continent-dns" params={{ one: "dns.src" }} />

### Source Country

Use this selector to filter based on the country where the query arrived to Gateway from. <Render product="cloudflare-one" file="gateway/selectors/source-country-dns" params={{ one: "dns.src" }} />

### Source IP

<Render file="gateway/selectors/source-ip-resolver" product="cloudflare-one" />

### Users

<Render file="gateway/selectors/users-dns" product="cloudflare-one" />

## Comparison operators

<Render file="gateway/comparison-operators" product="cloudflare-one" />

## Value

<Render
	file="gateway/value"
	product="cloudflare-one"
	params={{ one: "hostnames", two: "Host" }}
/>

## Logical operators

<Render
	file="gateway/logical-operators"
	product="cloudflare-one"
	params={{ one: "Identity" }}
/>
