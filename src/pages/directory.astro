---
import { getCollection, type CollectionEntry } from "astro:content";
// @ts-expect-error virtual module
import iconCollection from "virtual:astro-icon";
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import { getIconData, iconToSVG } from "@iconify/utils";
import DirectoryCatalog from "~/components/DirectoryCatalog";
import type { ProductData } from "~/components/DirectoryCatalog";
import type { StarlightPageProps } from "@astrojs/starlight/props";

let products: CollectionEntry<"products">[] = await getCollection(
	"products",
	(entry: CollectionEntry<"products">) => {
		return entry.data.product?.show ?? true;
	},
);

let productData: ProductData[] = products
	.map((product) => {
		const iconData = getIconData(iconCollection.local, product.id);
		let icon = undefined;
		if (iconData) {
			icon = iconToSVG(iconData);
		}

		return {
			...product,
			icon,
			groups: [
				product.data.product.group,
				...(product.data.product.additional_groups || []),
			].filter((val) => Boolean(val)),
		};
	})
	.sort((a, b) => a.id.localeCompare(b.id));

const props = {
	frontmatter: {
		title: "Docs directory",
		description: "Explore the different areas of our documentation site.",
		template: "splash",
	},
	hideBreadcrumbs: true,
} as StarlightPageProps;
---

<StarlightPage {...props}>
	<DirectoryCatalog products={productData} client:load />
</StarlightPage>
